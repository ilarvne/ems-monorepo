name: Deploy to Azure

on:
  workflow_run:
    workflows: ["Build & Push to ACR"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ${{ secrets.AZURE_REGISTRY_URL }}
  RESOURCE_GROUP: ems-rg
  REGISTRY_NAME: ${{ secrets.AZURE_REGISTRY_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get commit SHA
        id: sha
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SHA=$(git rev-parse --short HEAD)
          else
            SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
          fi
          echo "SHORT_SHA=$SHA" >> $GITHUB_OUTPUT

      - name: Deploy Backend
        run: |
          az containerapp update \
            --name ems-backend \
            --resource-group $RESOURCE_GROUP \
            --image ${{ env.REGISTRY }}/ems-backend:${{ steps.sha.outputs.SHORT_SHA }}

      - name: Deploy Frontend
        run: |
          az containerapp update \
            --name ems-frontend \
            --resource-group $RESOURCE_GROUP \
            --image ${{ env.REGISTRY }}/ems-frontend:${{ steps.sha.outputs.SHORT_SHA }}

      - name: Deploy Kratos
        run: |
          az containerapp update \
            --name ems-kratos \
            --resource-group $RESOURCE_GROUP \
            --image ${{ env.REGISTRY }}/ems-kratos:${{ steps.sha.outputs.SHORT_SHA }}

      - name: Deployment Summary
        run: |
          echo "### Deployment Complete :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | https://ems.studyverse.app |" >> $GITHUB_STEP_SUMMARY
          echo "| Auth (Kratos) | https://auth.studyverse.app |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | https://api.studyverse.app |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${{ steps.sha.outputs.SHORT_SHA }}\`" >> $GITHUB_STEP_SUMMARY
